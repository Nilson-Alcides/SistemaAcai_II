@model SistemaAcai_II.Models.VendasViewModel
@{
    ViewData["Title"] = "Editar Comanda";
}

<div class="container mt-4">
    <h2>Editar Comanda #@Model.Comanda.Id</h2>

    <!-- 🔎 Formulário de busca -->
    <form method="get" asp-action="EditarComanda" asp-controller="Comanda" class="mb-3">
        <input type="hidden" name="id" value="@Model.Comanda.Id" />
        <div class="input-group">
            <input type="text" name="termo" class="form-control" placeholder="Buscar produto por nome ou código" />
            <button type="submit" class="btn btn-primary">Pesquisar</button>
        </div>
    </form>

    <!-- 📋 Lista de produtos encontrados -->
    @if (Model.Produtos != null && Model.Produtos.Any())
    {
        <h4>Produtos Encontrados</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var produto in Model.Produtos)
                {
                    <tr>
                        <td>@produto.Id</td>
                        <td>@produto.Descricao</td>
                        <td>@produto.PrecoUn.ToString("C")</td>
                        <td>
                            @if (produto.Peso > 0)
                            {
                                <!-- Produto vendido por peso -->
                                <input type="number" step="0.001" min="0" id="peso_@produto.Id" placeholder="Peso (Kg)" />
                                <button type="button" class="btn btn-success btn-sm"
                                        onclick="adicionarProduto(@produto.Id, document.getElementById('peso_@produto.Id').value, 0)">
                                    Adicionar
                                </button>
                            }
                            else
                            {
                                <!-- Produto vendido por unidade -->
                                <input type="number" min="1" value="1" id="qtd_@produto.Id" />
                                <button type="button" class="btn btn-success btn-sm"
                                        onclick="adicionarProduto(@produto.Id, 0, document.getElementById('qtd_@produto.Id').value)">
                                    Adicionar
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- 🛒 Itens da comanda -->
    <h4 class="mt-4">Itens da Comanda</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Produto</th>
                <th>Quantidade/Peso</th>
                <th>Preço Unit.</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.ItensComanda)
            {
                var subtotal = (item.Peso > 0 ? item.Peso * item.RefProduto.PrecoUn : item.Quantidade * item.RefProduto.PrecoUn);
                <tr>
                    <td>@item.RefProduto.Descricao</td>
                    <td>
                        @if (item.RefProduto.Peso > 0)
                        {
                            @(item.Peso.HasValue ? item.Peso.Value.ToString("N3") + " Kg" : "")
                        }
                        else
                        {
                            @item.Quantidade
                        }
                    </td>
                    <td>@item.RefProduto.PrecoUn.ToString("C")</td>
                    <td class="totalItem">@subtotal.GetValueOrDefault().ToString("C")</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- 💰 Totais -->
    <div class="d-flex justify-content-end">
        <h4>Total: @Model.ItensComanda.Sum(i => (i.Peso > 0 ? i.Peso * i.RefProduto.PrecoUn : i.Quantidade * i.RefProduto.PrecoUn)).GetValueOrDefault().ToString("C")</h4>
    </div>

    <!-- 💾 Formulário para salvar alterações -->
    <form asp-action="SalvarEdicaoComanda" asp-controller="Comanda" method="post" class="mt-3">
        <input type="hidden" name="id" value="@Model.Comanda.Id" />

        <div class="mb-3">
            <label for="FormaPagamento">Forma de Pagamento</label>
            <select asp-for="Comanda.RefFormasPagamento.Id" asp-items="ViewBag.FormaPagamento" class="form-select"></select>
        </div>

        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        <a asp-action="Index" class="btn btn-secondary">Voltar</a>
    </form>
</div>

@section Scripts {
    <script>
        function adicionarProduto(id, peso, quantidade) {
            const url = '@Url.Action("AdicionarItem", "Comanda")';
            const formData = new URLSearchParams();
            formData.append('id', id);
            formData.append('pesoRcebido', peso ?? 0);
            formData.append('quantidade', quantidade ?? 0);
            formData.append('comandaId', '@Model.Comanda.Id'); // ID da comanda em edição

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            }).then(response => {
                if (response.ok) {
                    window.location.reload(); // recarrega a página para atualizar a tabela
                } else {
                    response.text().then(text => {
                        alert('Erro ao adicionar item: ' + text);
                    });
                }
            });
        }
    </script>
}
