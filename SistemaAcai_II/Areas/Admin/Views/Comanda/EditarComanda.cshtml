@model SistemaAcai_II.Models.VendasViewModel
@using SistemaAcai_II.Models.Constants
@inject SistemaAcai_II.Libraries.Login.LoginColaborador _colaborador

@{
    decimal totalComandaItens = 0M;
}

<div class="container mt-4">
    <h2>Editar Comanda #@Model.Comanda.Id</h2>

    <form asp-action="EditarComanda" method="get" id="formBusca" class="form-group row">
        <label for="termo" class="col-sm-2 col-form-label">Pesquisar Produto</label>
        <div class="col-sm-6">
            <input type="text" name="termo" id="termo" class="form-control" placeholder="Digite o nome, código ou peso*código..." autofocus value="@ViewBag.Termo" />
        </div>
        <div class="col-sm-4">
            <button type="submit" id="btnBuscar" class="btn btn-primary">Buscar</button>
        </div>
    </form>

@if (Model.Produtos != null && Model.Produtos.Any())
{
        <h3>Produtos encontrados</h3>
        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th>#Código</th>
                    <th>Nome</th>
                    <th>Preço Unitário</th>
                    <th>Medida</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var produto in Model.Produtos)
                {
                    <tr>
                        <td>@produto.Id</td>
                        <td>@produto.Descricao</td>
                        <td>@produto.PrecoUn.ToString("C")</td>
                        <td>
                            @if (produto.TipoMedidaEnum == TipoMedida.Kg)
                            {
                                <input type="text" class="form-control-sm col-3 pesoItemProduto" value="0" />
                            }
                            else
                            {
                                <input type="number" class="form-control-sm col-3 quantidadeItemProduto" value="1" min="1" />
                            }
                        </td>
                        <td>
                            <button type="button" class="btn btn-success btn-sm btn-adicionar-produto"
                                    data-id="@produto.Id"
                                    data-nome="@produto.Descricao"
                                    data-preco="@produto.PrecoUn"
                                    data-tipomedida="@produto.TipoMedidaEnum">
                                Adicionar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
}

    <div class="row">
        <div class="col-md-9">
            <h4>Itens da Comanda</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-sm" id="tabelaItens">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Descrição</th>
                            <th>Quantidade/Peso</th>
                            <th>Preço</th>
                            <th>Subtotal</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.ItensComanda)
                        {
                            var subtotal = item.Peso > 0
                            ? (decimal)item.Peso * item.RefProduto.PrecoUn
                            : Convert.ToDecimal(item.Quantidade * item.RefProduto.PrecoUn);
                            totalComandaItens += subtotal;

                            <tr data-id="@item.RefProduto.Id" data-guid="@item.RefProduto.IdItensGuid" data-porpeso="@(item.Peso > 0 ? "true" : "false")">
                                <td>@item.RefProduto.Id</td>
                                <td class="col-md-4">@item.RefProduto.Descricao</td>
                                <td class="col-md-3">
                                    @if (item.Peso > 0)
                                    {
                                        <div class="input-group">
                                            <input type="text" class="form-control-sm col-5 campo-peso pesoItem" value="@item.Peso.GetValueOrDefault().ToString("F3").Replace('.', ',')" />
                                            <span class="input-group-text">Kg</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="input-group">
                                            <input type="number" class="form-control-sm col-5 campo-peso quantidadeItem" value="@item.Quantidade" min="1" />
                                            <span class="input-group-text">Un</span>
                                        </div>
                                    }
                                </td>
                                <td class="col-md-3 precoUnitario" data-preco="@item.RefProduto.PrecoUn">@item.RefProduto.PrecoUn.ToString("C")</td>
                                <td class="col-md-3 totalItem">@subtotal.ToString("C")</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-outline-danger btn-sm btn-remover-item" data-guid="@item.RefProduto.IdItensGuid">Remover</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div id="formaPagamentoPrincipal" class="alert alert-secondary mt-3">
                Forma de Pagamento: <span id="formaPagamentoSelecionadaPrincipal">Não selecionada</span>
            </div>
            <div class="alert alert-info mt-3">
                <h4>Total da Comanda: <span id="totalComandaDisplay">@totalComandaItens.ToString("C")</span></h4>
            </div>
        </div>

        <div class="col-md-3">
            <form asp-action="FecharComandaEditada" asp-controller="Comanda" method="post" id="formFecharComanda">
                <input type="hidden" name="Comanda.RefFormasPagamento.Id" id="formaPagamentoId" />
                <input type="hidden" asp-for="Comanda.Desconto" id="inputDesconto" />
                <input type="hidden" asp-for="Comanda.Id" />
                <input type="hidden" asp-for="Comanda.ValorTotal" id="totalComandaDisplay" />
                <input type="hidden" id="itensJson" name="itensJson" />

                <div class="form-group mb-2">
                    <label asp-for="Comanda.NomeCliente"></label>
                    <input asp-for="Comanda.NomeCliente" class="form-control" />
                </div>

                <div id="cardPagamento" class="card border-primary shadow">
                    <div class="card-header bg-primary text-white">
                        <strong>Forma de Pagamento</strong>
                    </div>
                    <div class="card-body">
                        @foreach (var forma in ViewBag.FormaPagamento as SelectList)
                        {
                            <div class="form-check mb-2">
                                <input class="form-check-input formaPagamentoRadio" type="radio" name="radioFormaPagamento" value="@forma.Value" id="forma@forma.Value"
                                       @(Model.Comanda.RefFormasPagamento != null && Model.Comanda.RefFormasPagamento.Id.ToString() == forma.Value ? "checked" : "") />
                                <label class="form-check-label" for="forma@forma.Value">@forma.Text</label>
                            </div>
                        }

                        <div id="pagamentoDinheiro" style="display: none;">
                            <dl class="dlist-align">
                                <dt>Valor Pago:</dt>
                                <dd>
                                    <input id="valorPago" class="form-control form-control-sm dinheiro"
                                           type="text" style="width: 100px;" placeholder="0,00" />
                                </dd>
                            </dl>
                            <dl class="dlist-align">
                                <dt>Troco:</dt>
                                <dd>
                                    <input id="troco" class="form-control form-control-sm dinheiro"
                                           type="text" style="width: 100px;" placeholder="0,00" readonly />
                                </dd>
                            </dl>
                        </div>

                        <dl class="dlist-align">
                            <dt>Desconto:</dt>
                            <dd>
                                <input asp-for="Comanda.Desconto" id="desconto"
                                       class="form-control form-control-sm dinheiro"
                                       type="text" style="width: 100px;" placeholder="Ex.: 5,00 ou 10%" />
                            </dd>
                        </dl>
                    </div>
                </div>

            </form>
        </div>

        <div class="d-flex gap-2 mt-3">
            <button type="button" class="btn btn-outline-primary" id="btnAbrirPagamento">
                Pagamento (Alt + P)
            </button>
            <button type="submit" class="btn btn-outline-success" id="btnSalvarComanda" disabled>
                Finalizar (Alt + 5)
            </button>
            <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
        </div>
        <div></div>
    </div>

@section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // --------- Referências principais
                const btnSalvarComanda = document.getElementById('btnSalvarComanda');
                const nomeClienteInput = document.getElementById('Comanda_NomeCliente');
                const formBusca = document.getElementById('formBusca');
                const tabelaItens = document.querySelector('#tabelaItens tbody');
                const totalComandaDisplay = document.getElementById('totalComandaDisplay');
                const descontoInput = document.getElementById('desconto');

                // --------- Salvar Comanda (com envio de JSON)
                if (btnSalvarComanda) {
                    btnSalvarComanda.addEventListener('click', function (event) {
                        event.preventDefault();

                        if (nomeClienteInput && nomeClienteInput.value.trim() === '') {
                            nomeClienteInput.value = 'Não Informado';
                        }

                        const itens = [];
                        if (tabelaItens) {
                            tabelaItens.querySelectorAll('tr').forEach(tr => {
                                const quantidadeInput = tr.querySelector('.quantidadeItem');
                                const pesoInput = tr.querySelector('.pesoItem');
                                itens.push({
                                    ProdutoId: tr.dataset.id,
                                    IdItensGuid: tr.dataset.guid,                                   
                                    Quantidade: quantidadeInput ? parseInt(quantidadeInput.value) : 0,
                                    Peso: pesoInput ? parseFloat(pesoInput.value.replace(',', '.')) : 0
                                });
                            });
                        }

                        document.getElementById('itensJson').value = JSON.stringify(itens);
                        document.getElementById('formFecharComanda').submit();
                    });
                }

                // --------- Balança (polling)
                window.pesoDaBalanca = 0;
                window.balancaDisponivel = false;
                setInterval(() => {
                    fetch('@Url.Action("LerPeso", "Comanda")')
                        .then(response => response.json())
                        .then(data => {
                            window.pesoDaBalanca = parseFloat(data.peso.replace(',', '.')) || 0;
                            window.balancaDisponivel = window.pesoDaBalanca > 0;
                        });
                }, 500);

                // =====================================================================
                // BUSCA/ADIÇÃO PELO SUBMIT (igual Vendas) — sem cloneNode
                // =====================================================================
                if (formBusca) {
                    function parseNum(s) {
                        if (typeof s !== 'string') return NaN;
                        const v = parseFloat(s.replace(',', '.'));
                        return isNaN(v) ? NaN : v;
                    }

                    async function obterProdutoPorId(codigo) {
                        const url = `@Url.Action("ObterProdutoPorId", "Comanda")?id=${encodeURIComponent(codigo)}`;
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) return null;
                        return resp.json();
                    }

                    formBusca.addEventListener('submit', async (e) => {
                        const campo = document.getElementById('termo');
                        const termo = (campo?.value || '').trim();

                        if (!termo) return; // vazio -> busca textual segue

                        const temSep = /[*xX]/.test(termo);
                        const ehSoDigitos = /^\d+$/.test(termo);
                        const ehBuscaTextual = !temSep && !ehSoDigitos;

                        if (ehBuscaTextual) {
                            // descrição / nome -> NÃO previne
                            return;
                        }

                        // adição direta
                        e.preventDefault();

                        try {
                            let codigo = null, quantidade = 0, peso = 0;

                            if (temSep) {
                                const partes = termo.split(/[*xX]/).map(s => s.trim()).filter(Boolean);
                                const p1 = partes[0] || '';
                                const p2 = partes[1] || '';
                                const p1IsDigits = /^\d+$/.test(p1);
                                const p2IsDigits = /^\d+$/.test(p2);

                                if (p1IsDigits) {
                                    codigo = p1;
                                    const prod = await obterProdutoPorId(codigo);
                                    if (!prod) throw new Error('Produto não encontrado.');
                                    const tipo = ((prod.tipoMedida || prod.tipoMedidaEnum || '') + '').toLowerCase();

                                    if (tipo === 'kg') {
                                        const w = parseNum(p2);
                                        peso = (!isNaN(w) && w > 0) ? w : (window.balancaDisponivel ? (window.pesoDaBalanca || 0) : 0);
                                        quantidade = 0;
                                    } else {
                                        const q = parseNum(p2);
                                        quantidade = (!isNaN(q) && q > 0) ? Math.round(q) : 1;
                                        peso = 0;
                                    }
                                } else if (p2IsDigits) {
                                    codigo = p2;
                                    const prod = await obterProdutoPorId(codigo);
                                    if (!prod) throw new Error('Produto não encontrado.');
                                    const tipo = ((prod.tipoMedida || prod.tipoMedidaEnum || '') + '').toLowerCase();

                                    if (tipo === 'kg') {
                                        const w = parseNum(p1);
                                        peso = (!isNaN(w) && w > 0) ? w : (window.balancaDisponivel ? (window.pesoDaBalanca || 0) : 0);
                                        quantidade = 0;
                                    } else {
                                        const q = parseNum(p1);
                                        quantidade = (!isNaN(q) && q > 0) ? Math.round(q) : 1;
                                        peso = 0;
                                    }
                                } else {
                                    throw new Error('Formato inválido. Use "codigo*qtd" ou "peso*código".');
                                }
                            } else {
                                // sem separador: só código
                                codigo = termo;
                                const prod = await obterProdutoPorId(codigo);
                                if (!prod) throw new Error('Produto não encontrado.');
                                const tipo = ((prod.tipoMedida || prod.tipoMedidaEnum || '') + '').toLowerCase();

                                if (tipo === 'kg') {
                                    peso = window.balancaDisponivel ? (window.pesoDaBalanca || 0) : 0;
                                    quantidade = 0;
                                } else {
                                    quantidade = 1;
                                    peso = 0;
                                }
                            }

                            await adicionarItem(codigo, peso, quantidade);

                            if (campo) {
                                campo.value = '';
                                campo.focus();
                            }
                        } catch (err) {
                            alert(err.message || 'Erro ao processar a busca/adicionar item.');
                        }
                    });
                }

                // --------- Clique no "Adicionar" da lista de produtos
                document.querySelectorAll('.btn-adicionar-produto').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const produtoId = e.target.dataset.id;
                        const tipoMedida = e.target.dataset.tipomedida.toLowerCase();
                        let quantidade = 0;
                        let peso = 0;
                        const row = e.target.closest('tr');

                        if (tipoMedida === 'kg') {
                            const inputPeso = row.querySelector('.pesoItemProduto');
                            peso = parseFloat(inputPeso.value.replace(',', '.')) || 0;
                            if (peso <= 0) {
                                alert('Informe um peso válido.');
                                return;
                            }
                        } else {
                            const inputQuantidade = row.querySelector('.quantidadeItemProduto');
                            quantidade = parseInt(inputQuantidade.value) || 1;
                            if (quantidade <= 0) {
                                alert('Informe uma quantidade válida.');
                                return;
                            }
                        }
                        await adicionarItem(produtoId, peso, quantidade);
                    });
                });

                // --------- Adicionar item via fetch (POST) e render
                async function adicionarItem(id, peso, quantidade) {
                    const url = `@Url.Action("AdicionarItemNovo", "Comanda", new { comandaId = Model.Comanda.Id })`;
                    const formData = new URLSearchParams();
                    formData.append('id', id);
                    formData.append('pesoRcebido', peso > 0 ? peso.toFixed(3) : '0');
                    formData.append('quantidade', quantidade);

                    try {
                        const response = await fetch(url, { method: 'POST', body: formData });

                        if (response.ok) {
                            const novoItem = await response.json();
                            renderizarNovoItemNaTabela(novoItem);
                            atualizarTotais();
                        } else {
                            const text = await response.text();
                            alert('Erro ao adicionar item: ' + text);
                        }
                    } catch (error) {
                        console.error("Erro ao adicionar item:", error);
                        alert('Erro na comunicação com o servidor ao adicionar o item.');
                    }
                }

                // --------- Render da linha recém-adicionada
                function renderizarNovoItemNaTabela(item) {
                    const newRow = document.createElement('tr');
                    newRow.dataset.id = item.refProduto.id;
                    newRow.dataset.guid = item.idItensGuid; // GUID vem na raiz
                    newRow.dataset.porpeso = item.peso > 0 ? "true" : "false";

                    const precoUnitario = parseFloat(item.refProduto.precoUn.replace(',', '.'));
                    const subtotal = item.peso > 0 ? (item.peso * precoUnitario) : (item.quantidade * precoUnitario);

                    newRow.innerHTML = `
                        <td>${item.refProduto.id}</td>
                        <td>${item.refProduto.descricao}</td>
                        <td>
                            <div class="input-group">
                                ${item.peso > 0
                                    ? `<input type="text" class="form-control-sm col-5 campo-peso pesoItem" value="${item.peso.toFixed(3).replace('.', ',')}" />
                                       <span class="input-group-text">Kg</span>`
                                    : `<input type="number" class="form-control-sm col-5 campo-peso quantidadeItem" value="${item.quantidade}" min="1" />
                                       <span class="input-group-text">Un</span>`
                                }
                            </div>
                        </td>
                        <td class="precoUnitario" data-preco="${precoUnitario.toString().replace('.', ',')}">R$ ${item.refProduto.precoUn}</td>
                        <td class="totalItem">${subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-outline-danger btn-sm btn-remover-item" data-guid="${item.idItensGuid}">Remover</button>
                        </td>
                    `;

                    tabelaItens.appendChild(newRow);
                }

                // --------- Cálculo unificado: subtotal + desconto + total + troco
                function atualizarTotais() {
                    const numFromPtBR = (s) => {
                        if (!s) return 0;
                        s = (''+s).trim().replace(/\./g, '').replace(',', '.');
                        const n = parseFloat(s);
                        return isNaN(n) ? 0 : n;
                    };
                    const formatPtBR = (n) => (isNaN(n) ? 'R$ 0,00' : n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));

                    // 1) Subtotal
                    let subtotal = 0;
                    const linhas = tabelaItens ? tabelaItens.querySelectorAll('tr') : [];
                    linhas.forEach(tr => {
                        const precoStr = tr.querySelector('.precoUnitario')?.dataset.preco || "0";
                        const preco = numFromPtBR(precoStr);

                        const qtdEl = tr.querySelector('.quantidadeItem');
                        const pesoEl = tr.querySelector('.pesoItem');

                        let linhaSubtotal = 0;
                        if (pesoEl) {
                            const peso = numFromPtBR(pesoEl.value);
                            if (peso > 0) linhaSubtotal = peso * preco;
                        } else if (qtdEl) {
                            const qtd = parseInt(qtdEl.value) || 0;
                            if (qtd > 0) linhaSubtotal = qtd * preco;
                        }

                        const totalItem = tr.querySelector('.totalItem');
                        if (totalItem) totalItem.innerText = formatPtBR(linhaSubtotal);

                        subtotal += linhaSubtotal;
                    });

                    // 2) Desconto: "10%" ou "5,50"
                    let descontoTxt = descontoInput ? descontoInput.value.trim() : '';
                    let descontoValor = 0;

                    if (descontoTxt && descontoTxt.includes('%')) {
                        const perc = numFromPtBR(descontoTxt.replace('%',''));
                        descontoValor = subtotal * (perc / 100);
                    } else {
                        descontoValor = numFromPtBR(descontoTxt);
                    }

                    // 3) Total
                    let totalFinal = subtotal - descontoValor;
                    if (totalFinal < 0) totalFinal = 0;

                    if (totalComandaDisplay) totalComandaDisplay.innerText = formatPtBR(totalFinal);

                    // 4) Sincroniza hidden para o servidor (valor absoluto, vírgula)
                    const inputDescontoHidden = document.getElementById('inputDesconto');
                    if (inputDescontoHidden) {
                        inputDescontoHidden.value = descontoValor.toFixed(2).replace('.', ',');
                    }

                    // 5) Troco (se houver campo)
                    const valorPagoEl = document.getElementById('valorPago');
                    const trocoEl = document.getElementById('troco');
                    if (valorPagoEl && trocoEl) {
                        const valorPago = numFromPtBR(valorPagoEl.value);
                        const troco = valorPago - totalFinal;
                        trocoEl.value = formatPtBR(troco);
                    }
                }

                // --------- Eventos da tabela e UI
                if (tabelaItens) {
                    tabelaItens.addEventListener('click', function (e) {
                        if (e.target.classList.contains('btn-remover-item')) {
                            const guid = e.target.dataset.guid;
                            if (guid) {
                                const url = `@Url.Action("RemoverItemAjax", "Comanda")?id=${guid}`;
                                fetch(url, { method: 'DELETE' })
                                    .then(response => {
                                        if (response.ok) {
                                            e.target.closest('tr').remove();
                                            atualizarTotais();
                                        } else { alert('Erro ao remover o item.'); }
                                    })
                                    .catch(error => { console.error(error); alert('Erro na comunicação com o servidor.'); });
                            }
                        }
                    });

                    tabelaItens.addEventListener('input', function (e) {
                        if (e.target.classList.contains('quantidadeItem') || e.target.classList.contains('pesoItem')) {
                            atualizarTotais();
                        }
                    });
                }

                // --------- jQuery init: máscara, forma de pagamento e eventos
                $(document).ready(function () {
                    $('.dinheiro').mask("#.##0,00", { reverse: true });

                    const valorPagoInput = $('#valorPago');
                    const formaPagamentoRadios = $('input[name="radioFormaPagamento"]');
                    const formaPagamentoId = $('#formaPagamentoId');
                    const formaPagamentoSelecionadaPrincipal = $('#formaPagamentoSelecionadaPrincipal');
                    const btnSalvar = $('#btnSalvarComanda');
                    const btnAbrirPagamento = $('#btnAbrirPagamento');
                    const cardPagamento = $('#cardPagamento');

                    function atualizarVisibilidadeDinheiro() {
                        const texto = $('input[name="radioFormaPagamento"]:checked').next('label').text().toLowerCase();
                        if (texto.includes('dinheiro')) {
                            $('#pagamentoDinheiro').show();
                        } else {
                            $('#pagamentoDinheiro').hide();
                            valorPagoInput.val('');
                            $('#troco').val('');
                        }
                        atualizarTotais();
                    }

                    function inicializarFormaPagamento() {
                        const checkedRadio = $('input[name="radioFormaPagamento"]:checked');
                        if (checkedRadio.length > 0) {
                            formaPagamentoId.val(checkedRadio.val());
                            formaPagamentoSelecionadaPrincipal.text(checkedRadio.next('label').text());
                            btnSalvar.prop('disabled', false);
                            atualizarVisibilidadeDinheiro();
                        }
                    }

                    // Abrir/Fechar card pagamento
                    btnAbrirPagamento.click(() => cardPagamento.toggle());

                    // Seleção de forma de pagamento
                    formaPagamentoRadios.change(function () {
                        formaPagamentoId.val($(this).val());
                        formaPagamentoSelecionadaPrincipal.text($(this).next('label').text());
                        atualizarVisibilidadeDinheiro();
                        btnSalvar.prop('disabled', !formaPagamentoId.val());
                    });

                    // Eventos que impactam total/troco
                    $('#valorPago').on('input', atualizarTotais);
                    $('#desconto').on('input', atualizarTotais);

                    // Inicializações
                    inicializarFormaPagamento();
                    atualizarTotais();
                });
            });
        </script>
}
